# Copyright 2023 Intrinsic Innovation LLC

From 78b6582e177ffee7ec67cc7bc48d28d7c6cb7142 Mon Sep 17 00:00:00 2001
From: ferstl
Date: Tue, 1 Aug 2023 14:34:43 +0200
Subject: [PATCH 2/2] Generate pyi stubs in py_proto_library (from protobuf repo).

---
 protobuf.bzl | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/protobuf.bzl b/protobuf.bzl
index d96eeb4c9..c5e76f3b6 100644
--- a/protobuf.bzl
+++ b/protobuf.bzl
@@ -58,7 +58,8 @@ def _ObjcOuts(srcs, out_type):
     return _ObjcHdrs(srcs) + _ObjcSrcs(srcs)

 def _PyOuts(srcs, use_grpc_plugin = False):
-    ret = [s[:-len(".proto")] + "_pb2.py" for s in srcs]
+    ret = ([s[:-len(".proto")] + "_pb2.py" for s in srcs] +
+           [s[:-len(".proto")] + "_pb2.pyi" for s in srcs])
     if use_grpc_plugin:
         ret += [s[:-len(".proto")] + "_pb2_grpc.py" for s in srcs]
     return ret
@@ -155,6 +156,8 @@ def _proto_gen_impl(ctx):

             # Otherwise, rely on user-supplied outs.
             args += [("--%s_out=" + path_tpl) % (lang, gen_dir)]
+            if lang == "python":
+                args += [("--pyi_out=" + path_tpl) % gen_dir]

         if ctx.attr.outs:
             outs.extend(ctx.attr.outs)
--
2.41.0.585.gd2178a4bd4-goog

